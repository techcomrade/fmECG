<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login admin server</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  </head>
  <body>
    <div id="container" class="container">
      <!-- FORM SECTION -->
      <div class="row">
        <!-- SIGN UP -->
        <div class="col align-items-center sign-up">
          <div class="form-wrapper ">
            <div class="form sign-up sign-up-form">
              <div class="input-group">
                <i class="bx bxs-user"></i>
                <label for="username-label">Username </label>
                <input type="text" placeholder="Username" id="sign-up-username" class="sign-up-input" required />
              </div>
              <div class="input-group">
                <i class="bx bx-mail-send"></i>
                <label for="email-label">Email </label>
                <input type="email" placeholder="Email" id="sign-up-email" class="sign-up-input" required />
              </div>
              <div class="input-group">
                <i class="bx bxs-lock-alt"></i>
                <label for="passwor-label">Password </label>
                <input type="password" placeholder="Password" id="sign-up-password" class="sign-up-input" required />
                <i class="fa-solid fa-eye" id="show-password"></i>
              </div>
              <div class="input-group">
                <i class="bx bxs-lock-alt"></i>
                <label for="cf-password-label">Confirm Password </label>
                <input type="password" placeholder="Confirm Password" id="confirm-password" class="sign-up-input" required />
                <i class="fa-solid fa-eye" id="show-confirm-password"></i>
              </div>
              <div class="input-group">
                <i class="bx bxs-role"></i>
                <label for="role-label">Role </label>
                  <select id="sign-up-role" required>
                    <option value="">Choose a role</option>
                    <option value="0">Patient</option>
                    <option value="1">Doctor</option>
                  </select>
              </div>       
              <div class="input-group">
                <i class="bx bxs-birth"></i>
                <label for="birthday-label">Date of birth </label>
                <input type="date" id="sign-up-birth" class="sign-up-input" required/>
              </div>
              <div class="input-group">
                <i class="bx bxs-phone"></i>
                <label for="phone-number-label">Phone Number </label>
                <input type="text" placeholder="Phone Number" class="sign-up-input" id="sign-up-phone-number" />
              </div>
              <div class="input-group">
                <i class="bx bxs-img"></i>
                <label for="img">Select an image </label>
                <input type="file" id="sign-up-img" class="sign-up-input"/>
              </div>
              <button onclick="signupFunction()" >Sign up</button>
              <p class="align-center">
                <span> Already have an account? </span>
                <b onclick="toggle()" class="pointer"> Sign in here </b>
              </p>
            </div>
          </div>
        </div>
        <!-- END SIGN UP -->
        <!-- SIGN IN -->
        <div class="col align-items-center flex-col sign-in">
          <div class="form-wrapper">
            <div class="form sign-in">
              <div class="input-group">
                <i class="bx bxs-user"></i>
                <label for="username-login">Username</label>
                <input
                  type="text"
                  placeholder="Username"
                  id="input-user-name"
                  class="sign-in-input"
                />
              </div>
              <div class="input-group">
                <i class="bx bxs-lock-alt"></i>
                <label for="password-login">Password</label>
                <input
                  type="password"
                  placeholder="Password"
                  id="input-password"
                  class="sign-in-input"
                />
                <i class="fa-solid fa-eye" id="show-password-sign-in"></i>
              </div>
              <button onclick="loginFunction()">Sign in</button>
              <p class="align-center">
                <b> Forgot password? </b>
              </p>
              <p class="align-center">
                <span> Don't have an account? </span>
                <b onclick="toggle()" class="pointer"> Sign up here </b>
              </p>
            </div>
          </div>
          <div class="form-wrapper"></div>
        </div>
        <!-- END SIGN IN -->
      </div>
      <!-- END FORM SECTION -->
      <!-- CONTENT SECTION -->
      <div class="row content-row">
        <!-- SIGN IN CONTENT -->
        <div class="col align-items-center flex-col">
          <div class="text sign-in">
            <h2>Welcome</h2>
          </div>
          <div class="img sign-in"></div>
        </div>

        <div class="col align-items-center flex-col">
          <div class="img sign-up"></div>
          <div class="text sign-up">
            <h2>Join with us</h2>
          </div>
        </div>

      </div>

    </div>

    <div id="myModal" class="modal">
      <div class="loading-spinner"></div>
    </div>
    </div>

    <script>
      // show/hide password in sign up
      const showPassword = document.querySelector("#show-password");
      const passwordField = document.querySelector("#sign-up-password");
      showPassword.addEventListener("click", () => {
        const type = passwordField.getAttribute("type") === "password" ? "text" : "password";
        passwordField.setAttribute("type", type);
        if(showPassword.classList.contains("fa-eye") && passwordField.getAttribute("type") === "text") {
          showPassword.classList.remove("fa-eye");
          showPassword.classList.add("fa-eye-slash");
        }
        if(showPassword.classList.contains("fa-eye-slash") && passwordField.getAttribute("type") === "password" ) {
          showPassword.classList.remove("fa-eye-slash");
          showPassword.classList.add("fa-eye");
        }
      })

      const showConfirmPassword = document.querySelector("#show-confirm-password");
      const confirmPassword = document.querySelector("#confirm-password");
      showConfirmPassword.addEventListener("click", () => {
        const type = confirmPassword.getAttribute("type") === "password" ? "text" : "password";
        confirmPassword.setAttribute("type", type);
        if(showConfirmPassword.classList.contains("fa-eye") && confirmPassword.getAttribute("type") === "text") {
          showConfirmPassword.classList.remove("fa-eye");
          showConfirmPassword.classList.add("fa-eye-slash");
        }
        if(showConfirmPassword.classList.contains("fa-eye-slash") && confirmPassword.getAttribute("type") === "password" ) {
          showConfirmPassword.classList.remove("fa-eye-slash");
          showConfirmPassword.classList.add("fa-eye");
        }
      })

      //show/hide password in sign in
      const showPassSignIn = document.querySelector("#show-password-sign-in");
      const passwordSignIn = document.querySelector("#input-password");
      showPassSignIn.addEventListener("click", () => {
        const type = passwordSignIn.getAttribute("type") === "password" ? "text" : "password";
        passwordSignIn.setAttribute("type", type);
        if(showPassSignIn.classList.contains("fa-eye") && passwordSignIn.getAttribute("type") === "text") {
          showPassSignIn.classList.remove("fa-eye");
          showPassSignIn.classList.add("fa-eye-slash");
        }
        if(showPassSignIn.classList.contains("fa-eye-slash") && passwordSignIn.getAttribute("type") === "password" ) {
          showPassSignIn.classList.remove("fa-eye-slash");
          showPassSignIn.classList.add("fa-eye");
        }
      })

      let container = document.getElementById("container");

      const toggle = () => {
        container.classList.toggle("sign-in");
        container.classList.toggle("sign-up");
      };
      setTimeout(() => {
        container.classList.add("sign-in");
      }, 200);

      //sign in
      var loginUrl = `<%= url %>`;
      const loginFunction = async () => {
        const username = document.querySelector("#input-user-name").value;
        const password = document.querySelector("#input-password").value;
        console.log(username);
        if (username && password) {
          document.getElementById('myModal').style.display = 'grid';
          try {
            const loginResult = await fetch(loginUrl, {
              method: "POST",
              mode: "cors", 
              cache: "no-cache", 
              credentials: "same-origin", 
              headers: {
                "Content-Type": "application/json",
              },
              redirect: "follow",
              referrerPolicy: "no-referrer",
              body: JSON.stringify({
                username: username,
                password: password,
              }),
            });
            if (loginResult.ok) {
              window.location.reload();
            } else {
              document.getElementById('myModal').style.display = 'none';
              window.alert("wrong username or password");
            }
          } catch (err) {
            console.log(err);
            document.getElementById('myModal').style.display = 'none';
            window.alert("error login");
          }
        } else {
          window.alert("input username and password");
        }
      };

      //sign up
      var signupUrl ="http://localhost:3000/api/auth/register";
      const signupFunction = async () => {
        const username = document.querySelector("#sign-up-username").value;
        const email = document.querySelector("#sign-up-email").value;
        const password = document.querySelector("#sign-up-password").value;

        const birthConvert = document.querySelector("#sign-up-birth").value;
        const birth = Date.parse(birthConvert);

        const role = document.querySelector("#sign-up-role").value;
        const confirmPassword = document.querySelector("#confirm-password").value;
        const phone_number = document.querySelector("#sign-up-phone-number").value;
        const image = document.querySelector("#sign-up-img").value;

        // const fReader = new FileReader();
        // fReader.readAsDataURL(inputImg);

        if(confirmPassword && confirmPassword === password) {
          try {
            const signupResult = await fetch(signupUrl, {
              method: "POST",
              mode: "cors", 
              cache: "no-cache", 
              credentials: "same-origin", 
              headers: {
                "Content-Type": "application/json",
              },
              redirect: "follow",
              referrerPolicy: "no-referrer",
              body: JSON.stringify({
                username: username,
                email: email,
                password: password,
                role: role,
                birth: birth,
                phone_number: phone_number,
                image: image,
              }),
            });
            if (signupResult.ok) {
              window.alert("Sign up successful!");
              window.location.reload();
            } else {
              let data = await signupResult.json();
              console.log(data.message);
              window.alert(data.message);
            }       
          } catch(err) {
            let data = await signupResult.json();
            console.log(data.message);
            window.alert("Error when sign up!");
          }
        }
        if(!confirmPassword) {
          window.alert("\"Confirm password\" is not allowed to be empty");
        }
        if(confirmPassword && confirmPassword !== password) {
          window.alert("Confirm password is wrong, please try again");
        }
      }

      // Detect Enter key 
      const loginInputs = document.querySelectorAll('.sign-in-input');
      loginInputs.forEach((input) => {
          input.addEventListener('keyup', function(event) {
              if (event.key === "Enter") {
                  loginFunction();
              }
          });
      });
      const signUpInputs = document.querySelectorAll('.sign-up-input');
      signUpInputs.forEach((input) => {
          input.addEventListener('keyup', function(event) {
              if (event.key === "Enter") {
                  signupFunction();
              }
          });
      });
    </script>
  </body>
</html>
